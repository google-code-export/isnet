<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:h="http://java.sun.com/jsf/html"
   xmlns:ui="http://java.sun.com/jsf/facelets"
   xmlns:a4j="http://richfaces.org/a4j"
   xmlns:rich="http://richfaces.org/rich"
   xmlns:f="http://java.sun.com/jsf/core"
   xmlns:c="http://java.sun.com/jstl/core">
	<ui:composition>
	<script type="text/javascript">//<![CDATA[
        function processObjectsChange() {
            var member = $("memberMessageForm:text").value;
            if(member){
            	var splitedVal = member.split("::");
            	if(splitedVal){
                    var chunkLength = splitedVal.length;

                    var lastMember = splitedVal[chunkLength-1];
                    var memberId = splitedVal[chunkLength-2];
                    var firstMember = splitedVal[0];
                    updateServerList(memberId,lastMember);
                    if(firstMember){
                    	 $("memberMessageForm:text").value = firstMember+"[ "+ lastMember +" ], ";
                    }
                    else{
                    	 $("memberMessageForm:text").value = "[ "+ lastMember +" ], ";
                    }
            	}
            }
        }
        function clearTooltips(){

        	$("memberMessageForm:idToToolTips1").hide();
        	$("memberMessageForm:idToToolTips2").hide();

        }

    //]]></script>
    <rich:modalPanel id="idmessageDialog"   domElementAttachment="parent"  autosized="true">      
      <f:facet name="header"><h:outputText value="New Message"/></f:facet>
      <f:facet name="controls">
                <h:graphicImage value="/images/close.png" style="cursor:pointer" onclick="Richfaces.hideModalPanel('idmessageDialog')" />
          </f:facet>              
         <h:form id="memberMessageForm">
          <rich:panel id="container">
        	<h:inputHidden value="#{messageHanlder.hasError}" id="errorCount"/>


				<a4j:jsFunction name="updateServerList"  action="#{messageHanlder.updateMemberListInServer}">
					<a4j:actionparam name="PRM1" 	/>
					<a4j:actionparam name="PRM2" 	/>					
				</a4j:jsFunction>
	          <h:dataTable rendered="#{messageHanlder.hasError}" value="#{messageHanlder.errMsgs}" var="msg" width="100%" columnClasses="error_panel_left_col,error_panel_right_col">
	             <f:facet name="header"><h:outputText  value="Please note the following errors"/> </f:facet>
	            <h:column >
	              <h:graphicImage value="/images/error2.png" boder="0" style="margin-top: 3px;"/>         
	            </h:column>
	            <h:column >
	             <h:outputText  value="#{msg}"/>
	            </h:column>         
	          </h:dataTable>      
	                                  
	          <h:panelGrid columns="2" id="gridMemberMessage" width="100%">
	           <h:outputText value="To"/>
	          <h:panelGroup>

              <h:inputText  id="text" value="#{messageHanlder.toMemberNameList}" style="width: 380px;" onfocus="clearTooltips()"></h:inputText>   
                 
              <h:outputText id="idToToolTips1" value="" />
              <h:panelGroup id="idToToolTips2" style="boeder: 1px solid gray; height: 10px; ">
              	Please enter user names or email addresses
               </h:panelGroup>     

                <rich:suggestionbox id="suggestionBoxId" for="text" tokens=",[]" 
                    rules="#{autoComplateStyle.rules}"
                    suggestionAction="#{messageHanlder.autocompleteMemberName}" var="result"
                    fetchValue="::#{result.memberId}::#{result.firstName} #{result.lastName}" rows="#{autoComplateStyle.intRows}"
                    first="#{autoComplateStyle.intFirst}"
                    minChars="#{autoComplateStyle.minchars}"
                    shadowOpacity="#{autoComplateStyle.shadowOpacity}"
                    border="#{autoComplateStyle.border}" width="#{autoComplateStyle.width}"
                    height="#{autoComplateStyle.height}"
                    shadowDepth="#{autoComplateStyle.shadowDepth}"
                    cellpadding="#{autoComplateStyle.cellpadding}"
                    nothingLabel="No member is associated with you" columnClasses="center"
                    usingSuggestObjects="false"
                    onselect="processObjectsChange();"
                    >
                    <h:column>
                        <h:outputText escape="false" value="#{result.firstName}" />
                    </h:column>
                    <h:column>
                        <h:outputText escape="false" value="#{result.lastName}" />
                    </h:column>                    

                </rich:suggestionbox>                    

				</h:panelGroup>
				
	            <h:outputText value="#{bundle.activity_log_subject}" />
	            <h:inputText id="idTopic" value="#{messageHanlder.currentMessage.subject}" style="width: 380px;"></h:inputText> 
	            
	            <h:outputText value="#{bundle.activity_log_body}" />                
	            <a4j:outputPanel layout="block">
	               <rich:editor id="idBody" width="382" height="170" 
           		   theme="simple" viewMode="visual"	value="#{messageHanlder.currentMessage.body}" >
                                 
          			</rich:editor>
	            </a4j:outputPanel>
	            <h:outputText value="Attachment:" />
		        <a4j:commandButton  value="Attach File" reRender="idAttachDialog" oncomplete="Richfaces.showModalPanel('idAttachDialog')"/>
 
				<h:outputText value=""/>

				 <ui:include src="../secure/sections/attachedFiles.xhtml" />

	        
                   
	            <h:outputText value=""/>
	            <h:panelGroup>
		            <h:panelGrid columns="2" width="100%" columnClasses="column_class_right,column_class_left">
		            	<a4j:commandButton onclick="forceBlockUI(ajaxWaitMsg);" action="#{messageHanlder.addNewMessage}"  value="#{bundle.message_button_send}" oncomplete="forceUnblockUI();ModalHelper.validateModal('memberMessageForm','idmessageDialog')"  
		                reRender="idDataGridMsg">               
		              </a4j:commandButton>
		              <a4j:commandButton value="#{bundle.message_button_cancel}" onclick="Richfaces.hideModalPanel('idmessageDialog')" />  
		            </h:panelGrid>
	            </h:panelGroup>  
    
	         </h:panelGrid>

		</rich:panel>
      </h:form>      
    </rich:modalPanel>  
  </ui:composition>
</html>
